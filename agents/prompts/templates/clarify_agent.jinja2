{#- System Prompt -#}
{%- block system_prompt -%}
{{ system_prompt_text }}
{%- endblock -%}

{#- Guidelines -#}
{%- if guidelines_text -%}
{{ guidelines_text }}
{%- endif -%}

{%- block user_prompt -%}
## Task Description
{{ context.query_md }}

## Input Data Preview
```json
{{ context.inputs_preview | tojson(indent=2) }}
```

## Question Budget
- Total allowed: {{ context.max_questions if context.max_questions is not none else "unlimited" }}
- Used so far: {{ context.questions_used }}
- Remaining: {{ (context.max_questions - context.questions_used) if context.max_questions is not none else "unlimited" }}
- Max per Ask: {{ [context.max_questions_per_ask, (context.max_questions - context.questions_used)] | min if context.max_questions is not none else context.max_questions_per_ask }}

## Prior Q&A History
{% if context.qa_history %}
{% for qa in context.qa_history %}
- **Q**: {{ qa.question }}
  **A**: {{ qa.answer }}

{% endfor %}
{% else %}
(No questions asked yet)
{% endif %}

{#- Runtime Feedback (from previous invalid action) -#}
{% if context.runtime_feedback %}
> [!CAUTION]
> **Your previous response was invalid.**
> - Error: {{ context.runtime_feedback.parse_error }}
> - Hint: {{ context.runtime_feedback.hint }}
{% endif %}

---

**Your turn**: Analyze the task description and input preview.
- If you identify ambiguities that need clarification, output `Ask: <question(s)>`
- If the task is clear enough (or budget exhausted), output `Done:`

{% if context.max_questions is not none and context.questions_used >= context.max_questions %}
> [!WARNING]
> Question budget exhausted. You MUST output `Done:` now.
{% endif %}
{%- endblock -%}
