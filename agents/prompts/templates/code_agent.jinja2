{#- System Prompt -#}
{%- block system_prompt -%}
{{ system_prompt_text }}
{%- endblock -%}

{#- Guidelines -#}
{%- if guidelines_text -%}
{{ guidelines_text }}
{%- endif -%}

{#- Main User Content -#}
{%- block user_prompt -%}
## Task Description
{{ context.query_md }}

{%- if context.run_mode in ["cleanspec", "profile"] and context.cleanspec_appendix %}
## CleanSpec Appendix
This appendix contains required supplemental cleaning operations.
Apply these rules in addition to the main specification.
{{ context.cleanspec_appendix }}
{%- endif %}

## Input Data
```json
{
  "task_dir": "{{ context.task_dir }}",
  "inputs": {{ context.inputs | tojson }},
  "inputs_preview": {{ context.inputs_preview | tojson(indent=2) }}
}
```

{#- Mode-specific context controlled by run-mode capabilities -#}
{%- if context.allow_profile and context.profile_summary %}

## Profile Agent Findings
This is a profiling summary based on probing the input CSVs.
Use it to guide parsing and cleaning rules, but do NOT hard-code specific data values.

> [!NOTE]
> This profile summary is a non-binding suggestion. If it conflicts with the
> main task specification or clarification answers, the specification takes precedence.

{{ context.profile_summary }}
{%- endif %}

{%- if context.allow_clarify and context.qa_history %}

## User Clarifications
These are authoritative answers from the clarify phase. Apply them as binding business rules.
If they conflict with the input preview or profile insights, follow these clarifications.
{% for qa in context.qa_history %}
- **Q**: {{ qa.question }}
  **A**: {{ qa.answer }}{% if qa.canonical_value %} (`{{ qa.canonical_value }}`){% endif %}

{% endfor %}
Use these clarifications to guide your implementation. They take precedence over default assumptions.
{%- endif %}


{#- Feedback Block (if any) -#}
{%- if feedback -%}
---
### Feedback on Previous Attempt
{%- if feedback.execution and not feedback.execution.ok -%}
> [!WARNING] 
> **REPAIR MODE**: Your previous code failed to execute. Fix the error below.

#### Execution Error
- **Stderr**:
```
{{ feedback.execution.stderr }}
```

{%- if exec_error_instructions %}
{{ exec_error_instructions }}
{%- endif -%}
{%- endif -%}

{#- Previous Code -#}
{%- if feedback.prev_code -%}
#### Previous Code (with issues)
```python
{{ feedback.prev_code }}
```
{%- endif -%}

{%- endif -%}




{#- Final Instruction -#}
Generate ONLY the `solve` function in a single ```python code block.
{%- endblock -%}
