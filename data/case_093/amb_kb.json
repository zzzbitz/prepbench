{
  "ambiguities": [
    {
      "id": "1_O2_left_join_from_on_time",
      "kind": "Multi-table alignment",
      "node_id": "join_combined",
      "op": "join",
      "source_text": "Combine with information on flights which were not delayed",
      "ref": "combined = on_time_raw.merge(delayed_summary, on=[\"Airport\", \"Type\"], how=\"left\")"
    },
    {
      "id": "2_O3_first_non_null_within_group",
      "kind": "Operation incomplete",
      "node_id": "pivot_wider_delayed",
      "op": "pivot",
      "source_text": "Aggregate the data so that you have 1 row per flight delay, instead of the current 3 rows",
      "ref": "def first_non_null(series: pd.Series) -> str:\n        non_null = series.dropna()\n        return non_null.iloc[0] if not non_null.empty else None\n\n        .agg({\n            \"Airport\": first_non_null,\n            \"Type\": first_non_null,\n            \"Delay\": first_non_null,\n        })"
    },
    {
      "id": "3_O1_group_id_by_recordid_blocks_of_3",
      "kind": "Row-level concept",
      "node_id": "proj_delayed_gid",
      "op": "project",
      "source_text": "Aggregate the data so that you have 1 row per flight delay, instead of the current 3 rows",
      "ref": "group_id = (delayed_raw[\"RecordID\"] - 1) // 3"
    },
    {
      "id": "4_O2_impute_missing_delayed_as_zero",
      "kind": "Operation incomplete",
      "node_id": "project_impute",
      "op": "project",
      "intent": "When no delayed-flight summary matches an on-time (Airport, Type), set delayed_flights and total_delay to 0.",
      "ref": "combined[\"delayed_flights\"] = combined[\"delayed_flights\"].fillna(0).astype(int)\ncombined[\"total_delay\"] = combined[\"total_delay\"].fillna(0.0)"
    },
    {
      "id": "5_C2_metrics_denominator_total_flights",
      "kind": "Group-level concept",
      "node_id": "project_metrics",
      "op": "project",
      "source_text": "Calculate the average delay and % of flights which were delayed for each Airport, for each journey type",
      "ref": "combined[\"Total Flights\"] = combined[\"Number of flights\"] + combined[\"delayed_flights\"]\n\ndef calc_avg_delay(row):\n        if row[\"Total Flights\"] == 0:\n            return 0.0\n        return row[\"total_delay\"] / row[\"Total Flights\"]\n\ndef calc_pct_delayed(row):\n        if row[\"Total Flights\"] == 0:\n            return 0.0\n        return (row[\"delayed_flights\"] / row[\"Total Flights\"]) * 100"
    },
    {
      "id": "6_O1_round_half_up_2dp",
      "kind": "Operation boundary",
      "node_id": "script_round_half_up",
      "op": "script",
      "intent": "Round % Flights Delayed and Avg Delay (mins) to 2 decimal places using round-half-up.",
      "ref": "float(Decimal(str(value)).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP))"
    }
  ]
}